_.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g};window.App=window.App||{};App.Bloc=Backbone.Model.extend({resmx:[10,7,4,1,0],defaults:{state:4,score:0,bonus:0},setResult:function(e){e=parseInt(e,10);this.attributes.score=e<3?this.resmx[e]:0;this.attributes.bonus=e<4?1:0;this.set({state:e})}});App.BlocView=Backbone.View.extend({tagName:"div",className:"tile",tmpl:_.template($("#boulder_tmpl").html()),model:App.Bloc,events:{"change input[type=text]":"updateFromText","click  input[type=radio]":"updateFromRdio"},initialize:function(){this.$el.css("-webkit-tap-highlight-color","rgba(0,0,0,0)");this.listenTo(this.model,"change",this.update,this)},render:function(){this.$el.html(this.tmpl({id:this.model.get("id")}));this.update();return this},updateFromRdio:function(){var e=this.$el.find("input[type:radio]:checked").val();this.model.setResult(e)},updateFromText:function(){var e="error",t=this.$el.find(":text"),n=t.val(),r=n?_(this.model.resmx).indexOf(parseInt(n,10)):4;n=="0"&&t.val("");if(r>-1)t.removeClass(e);else{t.addClass(e);r=4}this.model.setResult(r)},update:function(){var e="toggleClass",t=this.model.get("state"),n=t<4?this.model.resmx[t]:null;this.$el.find(":radio")[t].checked=!0;this.$el.find(":text").val(n)[e]("gtext",t>2&&n!=null);this.$el[e]("bg-color-blueDark",t<4)}});App.Result=Backbone.Collection.extend({identity:{PerId:null,name:"name",code:null,category:"m"},score:0,bonus:0,model:App.Bloc,initialize:function(){this.on("change",this.setResult,this)},populate:function(e){while(e){this.add(new App.Bloc({id:"b"+e}));e--}return this},load:function(e){var t=this;$.getJSON("./scripts/get.php",{PerId:e},function(e){t.identity=e.identity;t.trigger("change:title");_(t.models).each(function(t){var n=t.get("id");t.setResult(e.results[n])})})},setResult:function(){this.score=this.bonus=0;_(this.models).each(function(e){this.score+=e.get("score");this.bonus+=e.get("bonus")},this)},post:function(){$.post("./scripts/post.php",{PerId:this.identity.PerId,models:JSON.stringify(this)},function(e){window.console.log(e)})}});App.MainView=Backbone.View.extend({el:$("#inner"),events:{"blur     #PerId":"tabResult","keypress #PerId":"loadResult","click    #submit":"postResult"},blocs:30,initialize:function(e){var t,n="collection",r=this.$el.find("#tiles"),i=e.blocs||this.blocs;this[n]=new App.Result;this[n].populate(i).each(function(e){t=new App.BlocView({model:e});r.prepend(t.render().el)});this.listenTo(this[n],"change",this.update,this);this.listenTo(this[n],"change:title",this.update,this)},tabResult:function(){var e=$("#PerId").val();if(!e)return;this.collection.load(e)},loadResult:function(e){var t=$("#PerId").val();if(!t||e.keyCode!=13)return;this.collection.load(t)},postResult:function(){this.collection.post()},update:function(){var e="collection";this.$("#name").html(this[e].identity.name);this.$("#ctgy").html("("+this[e].identity.category.toUpperCase()+")");this.$("#rslt").text(this[e].score+" / "+this[e].bonus)}});$(document).ready(function(){new App.MainView({blocs:30})});