var e;_.templateSettings={evaluate:/\{\[([\s\S]+?)\]\}/g,interpolate:/\{\{([\s\S]+?)\}\}/g};_.mixin({compareElements:function(e,t,n){var r=0;while(r<e[t].length&&r<e[n].length){if(e[t][r]<e[n][r])return 1;if(e[t][r]>e[n][r])return-1;r++}return 0},quicksort:function(e,t,n){var r,i="compareElements",s=t,o=n,u=t;while(s<=o){while(_[i](e,s,u)>0)s++;while(_[i](e,o,u)<0)o--;if(s<=o){r=e[s];e[s]=e[o];e[o]=r;s++;o--}}t<o&&_.quicksort(e,t,o);s<n&&_.quicksort(e,s,n)},titleize:function(e){return e==null?"":String(e).replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()})},strRight:function(e,t){var n;if(e==null)return"";e=String(e);t=t!=null?String(t):t;n=t?e.indexOf(t):-1;return~n?e.slice(n+t.length,e.length):e}});window.App=window.App||{};App.Climber=Backbone.Model.extend({getResults:function(){var e="attributes",t=[];t[0]=-this[e].points;t[1]=-this[e].bonus;t[2]=-this[e].id;return t}});App.ClimberView=Backbone.View.extend({tagName:"li",events:{},initialize:function(){this.listenTo(this.model,"change",this.update,this)},render:function(){var e="model",t="category",n="rankorder",r=$("#climber_template").text(),i=_.template(r,{rank:this[e].get("currentranking")||1,name:_.titleize(this[e].get("name")),code:this[e].get(t).toUpperCase(),points:this[e].get("points"),bonus:this[e].get("bonus")});this.$el.html(i);this.$(".rank").addClass(this[e].get(t));this.$el.data(n,this[e].get(n));return this},update:function(){var e="model",t="points",n="bonus",r=parseInt(100*this[e].get(t),10)+parseInt(this[e].get(n),10);this.$el.data("rankorder",-r);this.$(".rank").text(this[e].get("currentranking"));this.$(".pts").text(this[e].get(t));this.$(".bns").text(this[e].get(n))}});window.App=window.App||{};App.ResultsList=Backbone.Collection.extend({url:"./scripts/getJSON.php",model:App.Climber,initialize:function(e){this.cat=e.cat||"m"},loadResults:function(){var e=this.url+"?cat="+this.cat,t=$.Deferred(),n=$.getJSON(e),r=this;n.success(function(e){r.parseJSONData(e);r.reset(e);t.resolve(!0)});n.error(function(){t.resolve(!1)});return t},update:function(){var e=this.url+"?cat="+this.cat,t=$.Deferred(),n=$.getJSON(e),r=this;n.success(function(e){r.setResults(e);r.sort();t.resolve(!0)});n.error(function(){t.resolve(!1)});return t},parseJSONData:function(e){_(e).each(function(e){e.id=parseInt(e.startnumber,10);e.rankorder=e.id},this)},setResults:function(e){var t;_(e).each(function(e){t=this.get(e.startnumber);t.set({points:e.points,bonus:e.bonus})},this)},sort:function(){var e,t,n=[],r=[],i=this.models.length;_(this.models).each(function(e){r.push(e.getResults())});_(r).quicksort(0,i-1);n=_(r).map(function(e){return-_(e).last()});this.get(n[0]).set({currentranking:1,rankorder:1});_(r).each(function(e){e.pop()});for(t=1;t<i;t++){e=_(r).compareElements(t-1,t)===0?this.get(n[t-1]).get("currentranking"):t+1;this.get(n[t]).set({currentranking:e,rankorder:t+1})}}});App.ResultsListView=Backbone.View.extend({$resultsView:null,currentView:null,className:"resultslistview",initialize:function(){},loadResults:function(e){var t,n,r="$resultsView",i=[],s=this;this.initViewContainer(e);_(this.resultslists).each(function(e){n=e.loadResults();$.when(n).done(function(n){n&&e.each(function(e){t=new App.ClimberView({model:e});s.climberviews.push(t);s[r].append(t.render().el);t.update()})});i.push(n)});$.when.apply(null,i).done(function(){s[r].isotope({itemSelector:"li",getSortData:{rankorder:function(e){return parseInt(e.data("rankorder"),10)}}});s.updateView()})},initViewContainer:function(e){var t="resultslists",n="ResultsList";this[t]=[];this[t].push(new App[n]({cat:e}));this[t].push(new App[n]({cat:e+"j"}));this.render()},render:function(){var e="currentView",t="<ul></ul>";this[e]&&this.close();this.climberviews=[];this.$el.html(t);this.$resultsView=this.$("ul");$("#wrapper").prepend(this.el);this[e]=this},updateView:function(e){var t,n="$resultsView",r=[],i=this;e||(e={});e.force_refresh&&_(this.resultslists).each(function(e){t=e.update();r.push(t)},this);$.when.apply(null,r).done(function(){var e="visible";i[n].isotope("updateSortData",i.$("li"));i[n].isotope({sortBy:"rankorder"});i.trigger("application_event:toggleajaxspinner")})}});e={init:function(){this.resultsView=new App.ResultsListView},updateResultsView:function(){window.console.log("update results called");this.resultsView.updateView({force_refresh:!0})}};$(document).ready(function(){_.extend(e,Backbone.Events);e.init();e.resultsView.loadResults("f");setTimeout(function(){e.updateResultsView()},5e3)});