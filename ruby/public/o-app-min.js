var App=App||{};App.RouteResult={params:{},data:[],fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/route",data:t}).then(function(e){try{this.data=e.map(function(e){var r=new App.PersonResult(e.start_order);return r.params=Object.assign({start_order:e.start_order},t),r.data=e,r.objectifyResults(),r})}catch(t){window.console.log(t)}}.bind(this))},updateResults:function(){var t=this.params;return m.request({method:"GET",url:"/results/route",data:t}).then(function(t){try{t.forEach(function(t){this.data.find(function(e){return e.data.per_id===t.per_id}).update(t)}.bind(this))}catch(t){window.console.log(t)}}.bind(this))},save:function(){}};var App=App||{};App.SettingsVC={view:function(t,e){return m("div#settings",[m("header",{className:App.connectionStatus()?"connected":"disconnected"},e.ss.comp.title||m.trust("&nbsp;")),m.component(App.ParamSV,{vm:e,key:"WetId",text:"competition"}),m.component(App.ParamSV,{vm:e,key:"Route",text:"round"}),m.component(App.ParamSV,{vm:e,key:"GrpId",text:"category"})])}},App.ParamSV={controller:function(t){this.set=function(e){switch(t.vm.ss[t.key]=e.toUpperCase()||null,t.key){case"WetId":t.vm.fetchCompetition();break;case"GrpId":t.vm.fetch();break;default:App.sessionStorage.set("o-appstate",t.vm.ss)}}},view:function(t,e){return m("span.modal",[m("label",e.text),m("input[type=text]",{onchange:m.withAttr("value",t.set.bind(t)),pattern:e.pattern||null,value:e.vm.ss[e.key]||m.trust("")})])}};var App=App||{};App.TableViewController={controller:function(){this.delete=function(){alert("starter deletion not yet implemented")},this.sorts=function(t){return{onclick:function(e){var r=e.target.getAttribute("data-sort-by");if(r){var n=t[0];t.sort(function(t,e){return t.data[r]>e.data[r]?1:t.data[r]<e.data[r]?-1:0}),n===t[0]&&t.reverse()}}}}},view:function(t,e){var r=e.vm.rd.data,n=e.vm.blocs;return m("table",t.sorts(r),[App[e.type].createHeaderRow(n),r.map(function(r){var n={vm:e.vm,person:r};return App[e.type].createContentRow(t,n)})])}},App.Results={createHeaderRow:function(t){return m("tr",[m("th[data-sort-by=result_rank]","Rk"),m("th[data-sort-by=lastname].w12.left","Lastname"),m("th[data-sort-by=firstname].w09.left","Firstname"),m("th[data-sort-by=nation]","IOC "),m("th[data-sort-by=start_order]","Sn "),m("th.w48.flex",[t.map(function(t){return m(".bloc",m.trust("p"+t))})]),m("th.w09","Result")])},createContentRow:function(t,e){var r=e.vm,n=e.person.data;return m("tr",[m("td",n.result_rank||m.trust(""),{result_rank:n.result_rank}),m("td.w12.left",n.lastname),m("td.w09.left",n.firstname),m("td",n.nation),m("td",n.start_order),m("td.w48.flex",[r.blocs.map(function(t){var a="p"+t,s=e.person;return m(".bloc",{key:n.per_id+"."+t},[m.component(this.AttemptsSubView,{vm:r,person:s,id:a,datatype:"b"}),m.component(this.AttemptsSubView,{vm:r,person:s,id:a,datatype:"t"})])}.bind(this))]),m("td.w09",n.result)])},AttemptsSubView:{controller:function(t){this.responseStatus=m.prop(!0),this.getPropertyValue=function(e,r){var n=t.person.data.result_json;return n[e]?n[e][r]:null},this.set=function(e){var r,n,a,s=t.person.data.result_json;s[t.id]||(s[t.id]={a:0}),r=parseInt(e,10),r=isNaN(r)?null:r,s[t.id][t.datatype]=this.prop=r,s[t.id].a=Math.max(s[t.id].a,this.prop),n=t.person.stringifySingleResult(t.id),a=t.person.save(n),a.then(function(){t.vm.rd.updateResults(),this.responseStatus(!0)}.bind(this)).then(null,function(){this.responseStatus(!1)}.bind(this))}},view:function(t,e){var r=e.person.data,n=t.getPropertyValue(e.id,e.datatype);return m("input[type=text]",{key:r.per_id+"."+e.id+e.datatype,placeholder:e.datatype,value:isNaN(n)?m.trust(""):n,className:t.responseStatus()?"connected":"disconnected",onchange:m.withAttr("value",t.set.bind(t))})}}},App.Starters={createHeaderRow:function(){return m("tr",[m("th[data-sort-by=start_order]","Sn"),m("th[data-sort-by=lastname].w12.left","Lastname"),m("th[data-sort-by=firstname].w09.left","Firstname"),m("th[data-sort-by=nation]","IOC"),m("th[data-sort-by=per_id]","ID"),m("th[data-sort-by=rank_prev_heat]","Prev Heat"),m("th",m.trust(""))])},createContentRow:function(t,e){var r=e.person,n=e.person.data;return m("tr",[m("td",n.start_order),m("td.w12.left",n.lastname),m("td.w09.left",n.firstname),m("td",n.nation),m("td",n.per_id),m("td",n.rank_prev_heat||m.trust("NA")),m("td",[m("button[outline=true].icon-trash-empty",{onclick:t.delete.bind(r)})])])}},App.Scores={createHeaderRow:function(){return m("tr",[m("th[data-sort-by=start_order]","Sn"),m("th.w12.left","Lastname"),m("th.w09.left","Firstname"),m("th","IOC"),m("th.w48","Score"),m("th.w09","Result")])},createContentRow:function(t,e){var r=e.person.data;return m("tr",[m("td",r.start_order),m("td.w12.left",r.lastname),m("td.w09.left",r.firstname),m("td",r.nation),m("td.w48"),m("td.w09")])}};var App=App||{};App.PersonResult=function(t){this.id=t,this.params={},this.data={}},App.PersonResult.prototype={fetch:function(t){},update:function(t){this.data.result=t.result,this.data.result_rank=t.result_rank,this.data.sort_values=t.sort_values,this.data.result_json=t.result_json,this.objectifyResults()},objectifyResults:function(){var t=this.data.result_json;try{var e=JSON.parse(t),r,n;for(var a in e){var s={a:null,b:null,t:null};for(var o in s)r=o+"[0-9]{1,}",n=e[a].match(r),s[o]=n?parseInt(n[0].slice(1),10):null;e[a]=s}this.data.result_json=e}catch(t){window.console.log(t)}},stringifySingleResult:function(t){var e=this.data.result_json[t],r={},n="";for(var a in e)null!==e[a]&&(n+=a+e[a]);return r[t]=n,JSON.stringify(r)},save:function(t){var e=this.params;return e.result_json=t,m.request({method:"PUT",url:"/results/person",data:e})}};var App=App||{};App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.SuperVC={view:function(t,e){return[m.component(App.SettingsVC,e.vm),m.component(App.RouterVC),m.component(App.TableViewController,{vm:e.vm,type:e.type})]}},App.RouterVC={view:function(){return m("#routes",[m("a[href='/']",{config:m.route},"Startlist"),m("a[href='/re']",{config:m.route},"Resultlist"),m("a[href='/sc']",{config:m.route},"Scoresheet")])}},App.init=function(){var t=App.RouteResult,e={WetId:null,Route:null,comp:{title:null}},r=App.sessionStorage.get("o-appstate");r||(r=e,App.sessionStorage.set("o-appstate",e));var n=new App.VM(t,r);m.route.mode="hash",m.route(document.body,"/",{"/":m.component(App.SuperVC,{vm:n,type:"Starters"}),"/re":m.component(App.SuperVC,{vm:n,type:"Results"}),"/sc":m.component(App.SuperVC,{vm:n,type:"Scores"})})}();