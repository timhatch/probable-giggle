var App=App||{};App.RouteResult={params:{},data:{},fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/route",data:t}).then(function(t){window.console.log(this.data),this.data=t,window.console.log(this.data)}.bind(this))},save:function(t){var s=this.params;return s.result_json=t,m.request({method:"PUT",url:"/results/route",data:s})}};var App=App||{};App.SettingsVC={controller:function(t){this.ss=t.ss,this.fetchCompetitionParams=function(){m.request({method:"GET",url:"/competition",data:{wet_id:t.ss.WetId}}).then(function(s){try{t.ss.comp=s,App.sessionStorage.set("o-appstate",t.ss)}catch(e){window.console.log("invalid response : "+e)}t.reset()}).then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},this.fetchResultList=function(){t.fetch(null)}},view:function(t){return m("div#settings",[m("header",{className:App.connectionStatus()?"connected":"disconnected"},m("span.details",t.ss.comp.title||m.trust("&nbsp;"))),m.component(App.ParamSV,t,{key:"WetId",text:"competition",pattern:"[0-9]"}),m.component(App.ParamSV,t,{key:"Route",text:"round"}),m.component(App.ParamSV,t,{key:"GrpId",text:"category"})])}},App.ParamSV={controller:function(t,s){this.params=s,this.ss=t.ss,this.set=function(e){switch(t.ss[s.key]=e.toUpperCase()||null,s.key){case"WetId":t.fetchCompetitionParams();break;case"GrpId":t.fetchResultList();break;default:App.sessionStorage.set("o-appstate",t.ss)}}},view:function(t){return m("div.modal",[m("input[type=text]",{placeholder:t.params.text,onchange:m.withAttr("value",t.set.bind(t)),pattern:t.params.pattern||null,value:t.ss[t.params.key]||m.trust("")})])}};var App=App||{};App.ResultsVC={controller:function(t){this.model=t.model,this.blocs=t.blocs,this.save=function(){var t=this.model.data.result_json,s=this.model.stringifyResults(t);this.model.save(JSON.stringify(s))}},view:function(t){var s=t.model.data;return m("tr",[m("td",s.result_rank||m.trust("")),m("td",s.lastname),m("td",s.firstname),m("td",s.nation),m("td",s.start_order),m("td",s.per_id),m("td",[t.blocs.map(function(t){var e="p"+t;return[m("span",e),m.component(App.AttemptsView,{person:s,id:e,datatype:"b"}),m.component(App.AttemptsView,{person:s,id:e,datatype:"t"})]})]),m("td",s.result),m("td",[m("button",{onclick:t.save.bind(t)},"Save")])])}},App.AttemptsView={controller:function(t){this.result=t.person.result_json,this.id=t.id,this.text=t.datatype,this.prop=this.result[t.id]?this.result[t.id][t.datatype]:null,this.set=function(s){this.result[t.id]||(this.result[t.id]={a:0}),this.result[t.id][t.datatype]=this.prop=parseInt(s,10)||null,this.result[t.id].a=Math.max(this.result[t.id].a,this.prop)}},view:function(t){return m("input[type=text]",{placeholder:t.text,value:t.prop||m.trust(""),onchange:m.withAttr("value",t.set.bind(t))})}},App.HeaderRow={controller:function(t){},view:function(t){return m("tr",[m("th[data-sort-by=data.result_rank]","Rank"),m("th[data-sort-by=lastname]","Lastname"),m("th[data-sort-by=firstname]","Firstname"),m("th[data-sort-by=nation]","Nation"),m("th[data-sort-by=start_order]","Start Nr"),m("th[data-sort-by=per_id]","UUID"),m("th","Scores"),m("th","Result"),m("th",m.trust(""))])}};var App=App||{};App.PersonResult=function(t){this.id=t,this.params={},this.data={}},App.PersonResult.prototype={fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/person",data:t}).then(function(t){this.data=t}.bind(this))},objectifyResults:function(t){window.console.log(t);try{var s=JSON.parse(t),e,n;for(var r in s){var a={a:null,b:null,t:null};for(var o in a)e=o+"[0-9]{1,}",n=s[r].match(e),a[o]=n?parseInt(n[0].slice(1),10):null;s[r]=a}return s}catch(i){window.console.log(i)}},stringifyResults:function(t){var s={};for(var e in t){var n=t[e],r="";s[e]=e;for(var a in n)n[a]&&(r+=a+n[a]);s[e]=r}return s},save:function(t){var s=this.params;return s.result_json=t,window.console.log(s),m.request({method:"PUT",url:"/results/person",data:s})}};var App=App||{};App.BoulderResultVM=function(t){this.id="p"+t,this.result={a:null,b:null,c:null},this.displayResult=""},App.BoulderResultVM.prototype={parse:function(t){var s=t.match("t[0-9]{1,}")||null,e=t.match("b[0-9]{1,}")||null,n=t.match("a[0-9]{1,}")||null;this.result.a=n?parseInt(n[0].slice(1),10):null,this.result.b=e?parseInt(e[0].slice(1),10):null,this.result.t=s?parseInt(s[0].slice(1),10):null,this.setResultString()},update:function(t){switch(t){case"b":this.result.t=0,this.result.a=this.result.a||3,this.result.b=this.result.b||3;break;case"1":case"2":case"3":this.result.b=this.result.b||parseInt(t,10),this.result.t=this.result.a=parseInt(t,10);break;default:this.result.t=this.result.b=this.result.a=0}this.setResultString()},setResultString:function(){var t=this.result.t?"t"+this.result.t:"",s=this.result.b?"b"+this.result.b:"",e=this.result.a?"a"+this.result.a:"";this.displayResult=t+(s[0]||""),this.resultString=e+s+t}};var App=App||{};App.VM=function(t,s){return{ss:s,rd:t,params:{},resArray:[],sumResults:function(){},parseModelData:function(t){window.console.log(t.params),t.data.forEach(function(s){var e=new App.PersonResult(s.start_order);s.result_json=e.objectifyResults(s.result_json),e.data=s,e.params=Object.assign({start_order:e.data.start_order},t.params),this.resArray.push(e)}.bind(this)),window.console.log(this.resArray)},composeURLParams:function(t){var e={Q:0,S:2,F:3},n={M:6,F:5,MJ:84,FJ:81,MA:82,FA:79,MB:83,FB:80};return{wet_id:parseInt(s.WetId,10)||0,route:e[s.Route]||0,grp_id:n[s.GrpId]||1}},fetch:function(t){var s=this.composeURLParams(t),e=this.rd.fetch(s);e.then(function(){try{this.parseModelData(this.rd)}catch(t){window.console.log(t)}}.bind(this)).then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},serialiseResults:function(){},save:function(){var s=[],e;s=this.resArray.map(function(t){return{start_order:t.data.start_order,result_json:JSON.stringify(t.stringifyResults(t.data.result_json))}}),e=t.save(s),e.then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},saveAll:function(){},reset:function(){}}};var App=App||{};App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.SuperVC={controller:function(){var t={WetId:null,Route:null,GrpId:null,comp:null};this.list=[{firstname:"John",lastname:"Smith"},{firstname:"Eddie",lastname:"Jones"}],this.ss=App.sessionStorage.get("o-appstate"),this.ss||(this.ss=t,App.sessionStorage.set("o-appstate",t)),this.vm=new App.VM(App.RouteResult,this.ss),this.sorts=function(){var t=this.list;return{onclick:function(s){var e=s.target.getAttribute("data-sort-by");if(e){var n=t[0];t.sort(function(t,s){return t[e]>s[e]?1:t[e]<s[e]?-1:0}),n===t[0]&&t.reverse()}window.console.log(t)}}},this.sorts2=function(){var t=this.vm.resArray;return{onclick:function(s){var e=s.target.getAttribute("data-sort-by");if(e){window.console.log(e);var n=t[0];t.sort(function(t,s){return t[e]>s[e]?1:t[e]<s[e]?-1:0}),n===t[0]&&t.reverse()}window.console.log(t)}}}},view:function(t){var s=t.vm,e=[1,2,3,4,5];return[m.component(App.SettingsVC,s),m("table",t.sorts(),[m.component(App.TestRow),t.list.map(function(t){return m("tr",[m("td",t.firstname),m("td",t.lastname)])})]),m("table",t.sorts2(),[m.component(App.HeaderRow),s.resArray.map(function(t){return m.component(App.ResultsVC,{model:t,blocs:e})})]),m("button",{onclick:s.save.bind(s)},"Save All")]}},App.TestRow={controller:function(t){},view:function(t){return m("tr",[m("th[data-sort-by=firstname]","Firstname"),m("th[data-sort-by=lastname]","Lastname")])}},m.mount(document.body,App.SuperVC);