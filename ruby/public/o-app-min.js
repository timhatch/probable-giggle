var App=App||{};App.RouteResult={params:{},data:[],fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/route",data:t}).then(function(e){try{this.data=e.map(function(e){var n=new App.PersonResult(e.start_order);return n.params=Object.assign({start_order:e.start_order},t),n.data=e,n.objectifyResults(),n})}catch(n){window.console.log(n)}}.bind(this))},save:function(){}};var App=App||{};App.SettingsVC={view:function(t,e){return m("div#settings",[m("header",{className:App.connectionStatus()?"connected":"disconnected"},e.ss.comp.title||m.trust("&nbsp;")),m.component(App.ParamSV,{vm:e,key:"WetId",text:"competition"}),m.component(App.ParamSV,{vm:e,key:"Route",text:"round"}),m.component(App.ParamSV,{vm:e,key:"GrpId",text:"category"})])}},App.ParamSV={controller:function(t){this.set=function(e){switch(t.vm.ss[t.key]=e.toUpperCase()||null,t.key){case"WetId":t.vm.fetchCompetition();break;case"GrpId":t.vm.fetch();break;default:App.sessionStorage.set("o-appstate",t.vm.ss)}}},view:function(t,e){return m("span.modal",[m("label",e.text),m("input[type=text]",{onchange:m.withAttr("value",t.set.bind(t)),pattern:e.pattern||null,value:e.vm.ss[e.key]||m.trust("")})])}};var App=App||{};App.TableViewController={controller:function(t){this.blocs=t.vm.blocs,this["delete"]=function(){alert("starter deletion not yet implemented")},this.sorts=function(t){return{onclick:function(e){var n=e.target.getAttribute("data-sort-by");if(n){var r=t[0];t.sort(function(t,e){return t.data[n]>e.data[n]?1:t.data[n]<e.data[n]?-1:0}),r===t[0]&&t.reverse()}}}}},view:function(t,e){var n=e.vm.rd.data,r=e.vm.blocs;return m("table",t.sorts(n),[App[e.type].createHeaderRow(r),e.vm.rd.data.map(function(n){return App[e.type].createContentRow(t,n)})])}},App.Results={createHeaderRow:function(t){return m("tr",[m("th[data-sort-by=result_rank]","Rk"),m("th[data-sort-by=lastname].w12.left","Lastname"),m("th[data-sort-by=firstname].w09.left","Firstname"),m("th[data-sort-by=nation]","IOC "),m("th[data-sort-by=start_order]","Sn "),m("th.w45.flex",[t.map(function(t){return m(".bloc",m.trust("p"+t))})]),m("th.w09","Result"),m("th.w03")])},createContentRow:function(t,e){var n=e.data;return m("tr",{id:e.data.per_id},[m("td",n.result_rank||m.trust(""),{result_rank:n.result_rank}),m("td.w12.left",n.lastname),m("td.w09.left",n.firstname),m("td",n.nation),m("td",n.start_order),m("td.w45.flex",[t.blocs.map(function(t){var r="p"+t;return m(".bloc",{key:n.per_id+"."+t},[m.component(this.AttemptsSubView,{person:e,id:r,datatype:"b"}),m.component(this.AttemptsSubView,{person:e,id:r,datatype:"t"})])}.bind(this))]),m("td.w09",n.result)])},AttemptsSubView:{controller:function(t){this.per_id=t.person.data.per_id,this.result=t.person.data.result_json,this.id=t.id,this.text=t.datatype,this.prop=this.result[t.id]?this.result[t.id][t.datatype]:null,this.set=function(e){var n,r,s;this.result[t.id]||(this.result[t.id]={a:0}),n=parseInt(e,10),n=isNaN(n)?null:n,this.result[t.id][t.datatype]=this.prop=n,this.result[t.id].a=Math.max(this.result[t.id].a,this.prop),r=t.person.stringifySingleResult(t.id),s=t.person.save(r),s.then(function(){window.console.log("success")}).then(null,function(){window.console.log("failure")})}},view:function(t){return m("input[type=text]",{key:t.per_id+"."+t.id+t.text,placeholder:t.text,value:null!==t.prop?t.prop:m.trust(""),onchange:m.withAttr("value",t.set.bind(t))})}}},App.Starters={createHeaderRow:function(){return m("tr",[m("th[data-sort-by=start_order]","Sn"),m("th[data-sort-by=lastname].w12.left","Lastname"),m("th[data-sort-by=firstname].w09.left","Firstname"),m("th[data-sort-by=nation]","IOC"),m("th[data-sort-by=per_id]","ID"),m("th[data-sort-by=rank_prev_heat]","Prev Heat"),m("th",m.trust(""))])},createContentRow:function(t,e){var n=e.data;return m("tr",[m("td",n.start_order),m("td.w12.left",n.lastname),m("td.w09.left",n.firstname),m("td",n.nation),m("td",n.per_id),m("td",n.rank_prev_heat||m.trust("NA")),m("td",[m("button[outline=true].icon-trash-empty",{onclick:t["delete"].bind(e)})])])}},App.Scores={createHeaderRow:function(){return m("tr",[m("th[data-sort-by=start_order]","Sn"),m("th.w12.left","Lastname"),m("th.w09.left","Firstname"),m("th","IOC"),m("th.w48","Score"),m("th.w09","Result")])},createContentRow:function(t,e){var n=e.data;return m("tr",[m("td",n.start_order),m("td.w12.left",n.lastname),m("td.w09.left",n.firstname),m("td",n.nation),m("td.w48"),m("td.w09")])}};var App=App||{};App.PersonResult=function(t){this.id=t,this.params={},this.data={}},App.PersonResult.prototype={fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/person",data:t}).then(function(t){this.data=t,this.objectifyResults()}.bind(this))},objectifyResults:function(){var t=this.data.result_json;try{var e=JSON.parse(t),n,r;for(var s in e){var a={a:null,b:null,t:null};for(var o in a)n=o+"[0-9]{1,}",r=e[s].match(n),a[o]=r?parseInt(r[0].slice(1),10):null;e[s]=a}this.data.result_json=e}catch(i){window.console.log(i)}},stringifySingleResult:function(t){var e=this.data.result_json[t],n={},r="";for(var s in e)null!==e[s]&&(r+=s+e[s]);return n[t]=r,JSON.stringify(n)},save:function(t){var e=this.params;return e.result_json=t,m.request({method:"PUT",url:"/results/person",data:e})}};var App=App||{};App.VM=function(t,e){return{ss:e,rd:t,blocs:[1,2,3,4],params:{},composeURLParams:function(){var t={Q:0,S:2,F:3},n={M:6,F:5,MJ:84,FJ:81,MA:82,FA:79,MB:83,FB:80};return{wet_id:parseInt(e.WetId,10)||0,route:t[e.Route]||0,grp_id:n[e.GrpId]||1}},fetch:function(t){var e=this.composeURLParams(t),n=this.rd.fetch(e);n.then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},fetchCompetition:function(){var t=this.ss.WetId;m.request({method:"GET",url:"/competition",data:{wet_id:t}}).then(function(t){try{this.ss.comp=t,App.sessionStorage.set("o-appstate",this.ss)}catch(e){window.console.log("invalid response : "+e)}this.reset()}.bind(this)).then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},reset:function(){}}};var App=App||{};App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.SuperVC={view:function(t,e){return[m.component(App.SettingsVC,e.vm),m.component(App.RouterVC),m.component(App.TableViewController,{vm:e.vm,type:e.type})]}},App.RouterVC={view:function(){return m("#routes",[m("a[href='/']",{config:m.route},"Startlist"),m("a[href='/re']",{config:m.route},"Resultlist"),m("a[href='/sc']",{config:m.route},"Scoresheet")])}},App.init=function(){var t=App.RouteResult,e={WetId:null,Route:null,comp:{title:null}},n=App.sessionStorage.get("o-appstate");n||(n=e,App.sessionStorage.set("o-appstate",e));var r=new App.VM(t,n);m.route.mode="hash",m.route(document.body,"/",{"/":m.component(App.SuperVC,{vm:r,type:"Starters"}),"/re":m.component(App.SuperVC,{vm:r,type:"Results"}),"/sc":m.component(App.SuperVC,{vm:r,type:"Scores"})})}();