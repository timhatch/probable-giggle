var App=App||{};App.PersonResult={params:{wet_id:999},data:{result_json:{}},fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/person",data:t}).then(function(t){try{this.data=t,this.objectifyResults()}catch(e){window.console.log(t)}}.bind(this))},objectifyResults:function(){var t=this.data.result_json;try{var e=JSON.parse(t),n,s;for(var r in e){var l={a:null,b:null,t:null};for(var o in l)n=o+"[0-9]{1,}",s=e[r].match(n),l[o]=s?parseInt(s[0].slice(1),10):null;e[r]=l}this.data.result_json=e}catch(t){window.console.log(t)}},stringifySingleResult:function(t){var e=this.data.result_json[t],n={},s="";for(var r in e)null!==e[r]&&(s+=r+e[r]);return n[t]=s,JSON.stringify(n)},save:function(t){var e=this.params;return e.result_json=t,m.request({method:"PUT",url:"/results/person_nomedia",data:e})}};var App=App||{};App.PersonSelectorView={controller:function(t){this.incrementStarter=function(){var e=t.start_order+1;t.result.b>0&&null===t.result.t?(t.result.t=0,t.save()):t.result.a>0&&null===t.result.b?(t.result.b=0,t.save()):0===t.result&&(t.result.a=t.result.b=t.result.t=null,t.save()),t.fetch(e)}},view:function(t,e){return m("#person",[m("label","Competitor "),m("input[type=text]",{pattern:"[0-9]",onchange:m.withAttr("value",e.fetch.bind(e)),value:e.start_order}),m("span.details",e.fullname||m.trust("&nbsp;")),m("input[type=text]",{style:"color:red",disabled:!0,value:e.result})])}};var App=App||{};App.SettingsVC={view:function(t,e){return m("div#settings",[m.component(App.ParamSV,{vm:e,key:"WetId",text:"competition"}),m.component(App.ParamSV,{vm:e,key:"Route",text:"round"}),m.component(App.ParamSV,{vm:e,key:"GrpId",text:"category"})])}},App.ParamSV={controller:function(t){this.set=function(e){t.vm.ss[t.key]=e.toUpperCase()||null,App.sessionStorage.set("m-appstate",t.vm.ss),t.vm.reset()}},view:function(t,e){return m("span.modal",[m("label",e.text),m("input[type=text]",{onchange:m.withAttr("value",t.set.bind(t)),value:e.vm.ss[e.key]||m.trust("")})])}};var App=App||{};App.ResultsViewController={view:function(t,e){var n=function(t,n){for(var s=t,r=[];s<=t+n;s++)r.push(m.component(App.ResultCell,{vm:e.vm,key:"p"+s}));return r};return m("div",[n(e.colstart,e.rows)])}},App.ResultCell={controller:function(t){this.parse=function(t){var e={a:null,b:null,t:null};switch(t){case"b":e.t=0,e.a=e.a||3,e.b=e.b||3;break;case"1":case"2":case"3":e.b=e.b||parseInt(t,10),e.t=e.a=parseInt(t,10);break;default:e.t=e.b=e.a=null}return e},this.set=function(e){var n={},s=t.vm.model.data.result_json,r;Object.defineProperty(n,t.key,{value:null}),Object.assign(s,n),s[t.key]=this.parse(e),r=t.vm.model.stringifySingleResult(t.key),t.vm.model.save(r),t.vm.sumResults()}},view:function(t,e){var n=e.vm.model.data.result_json,s="undefined"==typeof n[e.key]?{a:null,b:null,t:null}:n[e.key],r=s.t||(s.b?"b":null);return m("div.resultrow",[m("label",e.key),m("input[type=text]",{value:r,onchange:m.withAttr("value",t.set.bind(t))})])}};var App=App||{};App.VM=function(t,e){return{model:t,ss:e,start_order:null,fullname:null,result:null,sumResults:function(){window.console.log("sumResults called");var e=0,n=0,s=0,r=t.data.result_json;for(var l in r)r[l].t&&(e+=13,s+=3*r[l].t),(r[l].t||r[l].b)&&(n+=1);this.result=e-s+" b"+n},composeURLParams:function(t){var n={QA:0,QB:1,S:2,F:3,SF:4},s={M:6,F:5,MJ:84,FJ:81,MA:82,FA:79,MB:83,FB:80};return{wet_id:parseInt(e.WetId,10),route:n[e.Route],grp_id:s[e.GrpId],start_order:parseInt(t,10)}},fetch:function(e){if(null!==e){this.reset();var n=this.composeURLParams(e),s=t.fetch(n);s.then(function(){try{this.start_order=t.data.start_order,this.fullname=t.data.lastname+", "+t.data.firstname,this.sumResults()}catch(t){this.reset()}}.bind(this)).then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})}},reset:function(){this.start_order=null,this.fullname=null,this.result=null,this.model.data={result_json:{}},this.model.params={wet_id:999}}}};var App=App||{};App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.SuperVC={view:function(t,e){return[m.component(App.SettingsVC,e),m.component(App.PersonSelectorView,e),m("#tiles",[m.component(App.ResultsViewController,{vm:e,colstart:1,rows:4}),m.component(App.ResultsViewController,{vm:e,colstart:6,rows:4}),m.component(App.ResultsViewController,{vm:e,colstart:11,rows:4}),m.component(App.ResultsViewController,{vm:e,colstart:16,rows:4}),m.component(App.ResultsViewController,{vm:e,colstart:21,rows:4}),m.component(App.ResultsViewController,{vm:e,colstart:26,rows:4})])]}},App.init=function(){var t=App.PersonResult,e={WetId:null,Route:null,GrpId:null,State:!1,WetNm:null},n=App.sessionStorage.get("m-appstate");n||(n=e,App.sessionStorage.set("m-appstate",e));var s=App.VM(t,n);m.mount(document.body,m.component(App.SuperVC,s))}();