window.App=window.App||{},App.settingsVC={controller:function(){this.fetch=function(){for(var t in App.viewModel)if(null===App.viewModel[t])return;m.request({method:"GET",url:"/competition",data:{wet_id:App.viewModel.WetId}}).then(function(t){try{var e=t.title||"-";e+=" / "+App.viewModel.Route+" / "+App.viewModel.GrpId+" / "+App.viewModel.BlcNr,App.viewModel.WetNm=e,App.viewModel.State=!0,App.sessionStorage.set("AppState",App.viewModel)}catch(n){window.console.log("invalid response : "+n)}App.Person.reset(),App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})}},view:function(t){return m("div#settings",[m.component(App.parametersSubview,{key:"WetId",text:"competition",pattern:"[0-9]"}),m.component(App.parametersSubview,{key:"Route",text:"round"}),m.component(App.parametersSubview,{key:"GrpId",text:"category"}),m.component(App.parametersSubview,{key:"BlcNr",text:"boulder",pattern:"[0-9]"}),m("button.save",{type:"primary",outline:!0,upper:!0,onclick:t.fetch.bind(t)},"save")])}},App.parametersSubview={controller:function(t){this.set=function(e){App.viewModel[t.key]=e.toUpperCase()||null}},view:function(t,e){return m("div.modal",[m("label",e.text),m("input[type=text]",{onchange:m.withAttr("value",t.set.bind(t)),pattern:e.pattern||null,value:App.viewModel[e.key]})])}},window.App=window.App||{},App.headerVC={controller:function(){this.toggleSettings=function(){for(var t in App.viewModel)if(null===App.viewModel[t])return;var e=App.viewModel.State;App.viewModel.State=e?!1:!0}},view:function(t){return m("header",{className:App.connectionStatus()?"connected":"disconnected"},[m("button",{onclick:t.toggleSettings,square:!0},m.trust("&#9776;")),m("span.details",App.viewModel.WetNm||m.trust("&nbsp;"))])}},window.App=window.App||{},App.ResultsVC={controller:function(t){this.changeAttempts=function(e){var n="swipedown"===e.type?1:-1;t.incrementAttempts(n),m.redraw(!0)}},view:function(t,e){return m("div#results",{config:m.touchHelper({swipedown:t.changeAttempts.bind(t),swipeup:t.changeAttempts.bind(t)})},[m.component(App.searchSV,e),m.component(App.attemptsSV,e,{text:"Tops"}),m.component(App.attemptsSV,e,{text:"Bonus"}),m.component(App.attemptsSV,e,{text:"Attempts"})])}},App.searchSV={controller:function(t){this.incrementStarter=function(){var e=t.start_order+1;t.fetch(e)}},view:function(t,e){return m("div.search",[m("input[type=text]",{pattern:"[0-9]",onchange:m.withAttr("value",e.fetch.bind(e)),value:e.start_order}),m("span.details",e.fullname||m.trust("&nbsp;")),m("button",{square:!0,onclick:t.incrementStarter.bind(t)},m.trust("&#8594;"))])}},App.attemptsSV={controller:function(t,e){this.prop=e.text[0].toLowerCase(),this.changeValue=function(e){"swiperight"===e.type&&t.setResult(this.prop),"swipeleft"===e.type&&t.resetResult(this.prop),t.save(),m.redraw(!0)}},view:function(t,e,n){var p=e.result[t.prop];return m("div.row",{config:m.touchHelper({swiperight:t.changeValue.bind(t),swipeleft:t.changeValue.bind(t)})},[m("div.list",n.text),m("div.round",p?p:"-")])}},window.App=window.App||{},App.Person={start_order:null,fullname:null,result:{a:null,b:null,c:null},incrementAttempts:function(t){var e=this.result.a+t;this.result.a=e>=0?e:0,this.save()},setResult:function(t){var e=this.result;e[t]||(e[t]=e.a,"t"!==t||e.b||(e.b=e.a))},resetResult:function(t){this.result[t]&&(this.result[t]=0)},composeURI:function(t){var e={Q:0,S:2,F:3},n={M:6,F:5,MJ:84,FJ:81,MA:82,FA:79,MB:83,FB:80};return{wet_id:parseInt(App.viewModel.WetId,10),route:e[App.viewModel.Route],grp_id:n[App.viewModel.GrpId],start_order:parseInt(t,10)}},fetch:function(t){if(t){window.console.log(this.composeURI(t));var e=this;m.request({method:"GET",url:"/climber",data:e.composeURI(t)}).then(function(n){try{var p="p"+String(parseInt(App.viewModel.BlcNr,10)),o=JSON.parse(n.result_json)[p]||"";for(var r in e.result){var i=r+"[0-9]{1,}",s=o.match(i)||null;e.result[r]=s?parseInt(s[0].slice(1),10):null}e.fullname=n.lastname+", "+n.firstname,e.start_order=parseInt(t,10)||null}catch(l){window.console.log("invalid response : "+l)}App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})}},save:function(){var t=this.composeURI(this.start_order),e={},n="p"+String(parseInt(App.viewModel.BlcNr,10)),p="";for(var o in this.result)this.result[o]&&(p+=o+this.result[o]);e[n]=p,t.result_json=JSON.stringify(e),m.request({method:"PUT",url:"/climber",data:t}).then(function(t){window.console.log(t),App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},reset:function(){this.start_order=null,this.fullname=null,this.result={a:null,b:null,c:null}}},window.App=window.App||{},App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.viewModel={State:!1,WetId:null,Route:null,GrpId:null,BlcNr:null,WetNm:!1},App.SuperVC={controller:function(){var t=App.sessionStorage.get("AppState");t?App.viewModel=t:App.sessionStorage.set("AppState",App.viewModel)},view:function(t){return[App.headerVC,App.viewModel.State?m.component(App.ResultsVC,App.Person):App.settingsVC]}},m.mount(document.body,App.SuperVC);