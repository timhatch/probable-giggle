var App=App||{};App.PersonResult={params:{wet_id:999},data:{},fetch:function(t){return this.params=t,m.request({method:"GET",url:"/results/person",data:t}).then(function(t){try{this.data=t,this.objectifyResults()}catch(e){window.console.log(t)}}.bind(this))},objectifyResults:function(){var t=this.data.result_json;try{var e=JSON.parse(t),n,s;for(var r in e){var a={a:null,b:null,t:null};for(var o in a)n=o+"[0-9]{1,}",s=e[r].match(n),a[o]=s?parseInt(s[0].slice(1),10):null;e[r]=a}this.data.result_json=e}catch(u){window.console.log(u)}},stringifySingleResult:function(t){var e=this.data.result_json[t],n={},s="";for(var r in e)null!==e[r]&&(s+=r+e[r]);return n[t]=s,JSON.stringify(n)},save:function(t){var e=this.params;return e.result_json=t,m.request({method:"PUT",url:"/results/person",data:e})}};var App=App||{};App.HeaderVC={controller:function(t){this.toggleSettings=function(){for(var e in t.ss)if(null===t.ss[e])return;var n=t.ss.State;t.ss.State=n?!1:!0}},view:function(t,e){var n=(e.ss.Route||"-")+" / "+(e.ss.GrpId||"-")+" / "+(e.ss.BlcNr||"-");return m("header",{className:App.connectionStatus()?"connected":"disconnected"},[m("button",{onclick:t.toggleSettings,square:!0},m.trust("=")),m("span.details",n||m.trust("&nbsp;"))])}};var App=App||{};App.PersonSelectorView={controller:function(t){this.incrementStarter=function(){var e=t.start_order+1;t.result.b>0&&null===t.result.t?(t.result.t=0,t.save()):t.result.a>0&&null===t.result.b?(t.result.b=0,t.save()):0===t.result&&(t.result.a=t.result.b=t.result.t=null,t.save()),t.fetch(e)}},view:function(t,e){return m("div.search",[m("input[type=text]",{pattern:"[0-9]",onchange:m.withAttr("value",e.fetch.bind(e)),value:e.start_order}),m("span.details",e.fullname||m.trust("&nbsp;")),m("button",{square:!0,onclick:t.incrementStarter.bind(t)},m.trust("&#8594;"))])}};var App=App||{};App.ResultsVC={controller:function(t){this.changeAttempts=function(e){var n="swipedown"===e.type?1:-1,s=t.result.a+n;t.result.a=s>=0?s:0,t.save(),m.redraw(!0)}},view:function(t,e){return m("div#results",{config:m.touchHelper({swipedown:t.changeAttempts.bind(t),swipeup:t.changeAttempts.bind(t)})},[m.component(App.PersonSelectorView,e),m.component(App.AttemptsView,{vm:e,text:"Tops"}),m.component(App.AttemptsView,{vm:e,text:"Bonus"}),m.component(App.AttemptsView,{vm:e,text:"Attempts"})])}},App.AttemptsView={controller:function(t){this.changeValue=function(e){var n=t.text[0].toLowerCase();"swiperight"===e.type&&t.vm.setResult(n),"swipeleft"===e.type&&t.vm.resetValues(n),t.vm.save(),m.redraw(!0)}},view:function(t,e){var n=e.text[0].toLowerCase(),s=e.vm.result[n];return m("div.row",{config:m.touchHelper({swiperight:t.changeValue.bind(t),swipeleft:t.changeValue.bind(t)})},[m("div.list",e.text),m("div.round",s?s:"-")])}};var App=App||{};App.settingsVC={controller:function(t){this.fetch=function(){for(var e in t.ss)if(null===t.ss[e])return;t.fetch(1),t.ss.State=!0,App.sessionStorage.set("n-appstate",t.ss)}},view:function(t,e){return m("div#settings",[m.component(App.ParamSV,{ss:e.ss,key:"WetId",text:"competition",pattern:"[0-9]"}),m.component(App.ParamSV,{ss:e.ss,key:"Route",text:"round"}),m.component(App.ParamSV,{ss:e.ss,key:"GrpId",text:"category"}),m.component(App.ParamSV,{ss:e.ss,key:"BlcNr",text:"boulder",pattern:"[0-9]"}),m("button.save",{type:"primary",outline:!0,upper:!0,onclick:t.fetch.bind(t)},"save")])}},App.ParamSV={controller:function(t){this.set=function(e){t.ss[t.key]=e.toUpperCase()||null}},view:function(t,e){return m("div.modal",[m("label",e.text),m("input[type=text]",{onchange:m.withAttr("value",t.set.bind(t)),pattern:e.pattern||null,value:e.ss[e.key]})])}};var App=App||{};App.VM=function(t,e){return{model:t,ss:e,start_order:null,fullname:null,result:{a:null,b:null,t:null},setResult:function(t){this.result[t]||(this.result[t]=this.result.a,"t"!==t||this.result.b||(this.result.b=this.result.a))},resetValues:function(t){"a"!==t&&this.result[t]&&(this.result[t]=0)},composeURLParams:function(t){var n={Q:0,S:2,F:3},s={M:6,F:5,MJ:84,FJ:81,MA:82,FA:79,MB:83,FB:80};return{wet_id:parseInt(e.WetId,10),route:n[e.Route],grp_id:s[e.GrpId],start_order:parseInt(t,10)||1}},fetch:function(n){var s=this.composeURLParams(n),r=t.fetch(s);r.then(function(){try{var n="p"+String(parseInt(e.BlcNr,10));this.result=t.data.result_json[n]||{a:null,b:null,t:null},this.start_order=t.data.start_order,this.fullname=t.data.lastname+", "+t.data.firstname}catch(s){window.console.log(s)}}.bind(this)).then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)})},serialiseResults:function(){var t="p"+String(parseInt(e.BlcNr,10)),n={},s="";for(var r in this.result)null!==this.result[r]&&(s+=r+this.result[r]);return window.console.log(s),n[t]=s,JSON.stringify(n)},save:function(){var n="p"+String(parseInt(e.BlcNr,10));t.data.result_json[n]=this.result;var s=this.serialiseResults(),r;this.start_order&&(r=t.save(s),r.then(function(){App.connectionStatus(!0)}).then(null,function(){App.connectionStatus(!1)}))},reset:function(){this.start_order=null,this.fullname=null,this.result={a:null,b:null,t:null},t.data={}}}};var App=App||{};App.connectionStatus=m.prop(!0),App.sessionStorage=mx.storage("session",mx.SESSION_STORAGE),App.SuperVC={view:function(t,e){return[m.component(App.HeaderVC,e),e.ss.State?m.component(App.ResultsVC,e):m.component(App.settingsVC,e)]}},App.init=function(){var t=App.PersonResult,e={WetId:null,Route:null,GrpId:null,BlcNr:null,State:!1},n=App.sessionStorage.get("n-appstate");n||(n=e,App.sessionStorage.set("n-appstate",e));var s=App.VM(t,n);m.mount(document.body,m.component(App.SuperVC,s))}();